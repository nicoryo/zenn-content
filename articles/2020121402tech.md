---
title: "ã€ŒRails APIãƒ¢ãƒ¼ãƒ‰ã¨React Hooksã‚’ä½¿ã£ã¦ToDoãƒªã‚¹ãƒˆã‚’ä½œã‚‹ã€ã‚’dockerä¸Šã«é…ç½®ã™ã‚‹"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rails","React","hooks","axios", "docker"]
published: true
---

# ç›®çš„
ã“ã‚Œã‚‚ã‚„ã£ãŸã“ã¨ã®å‚™å¿˜éŒ²ãŒç›®çš„ã«ãªã‚Šã¾ã™ã€‚
Know Howã‚ˆã‚Šã€How to methodãªå†…å®¹ã«ã—ã¾ã™

# èƒŒæ™¯
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’åˆ†ã‘ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’dockerã«ã‚ã¨ä¹—ã›ã™ã‚‹è¨˜äº‹ãŒãªã‹ã£ãŸãŸã‚ã€‚
ã›ã£ã‹ãã‚„ã£ãŸã®ã ã‹ã‚‰è¨˜äº‹ã«ã—ã¡ã‚ƒãŠã†ã£ã¦è€ƒãˆã§ã™ã€‚

# ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³
1. docker-compose.ymlã‚’ç”¨æ„ã™ã‚‹
2. Dockerfile(Backendç”¨)ã‚’ç”¨æ„ã™ã‚‹
3. entrypoint.shã‚’ç”¨æ„ã™ã‚‹
4. Dockerfile(Frontendç”¨)ã‚’ç”¨æ„ã™ã‚‹
5. railså´ã®èª¿æ•´
6. axiosmaterial-uiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã‚„ã£ã¦ã¿ã‚ˆã†ï¼
# docker-compose.yml
æ—¢å­˜ã®railsã‚¢ãƒ—ãƒªç­‰ã«ã€Œå¾Œã‹ã‚‰dockerã€ã‚’ç”¨æ„ã™ã‚‹å ´åˆã§ã‚‚ã€
ã‚¢ãƒ—ãƒªã‚’ä½œã‚Šå§‹ã‚ã‚‹æ™‚ã§ã‚‚ã€ã‚„ã‚‹ã“ã¨ã¯ã»ã¨ã‚“ã©å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚

docker-compose.ymlã¯ãƒ¡ã‚¤ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸Šã«é…ç½®ã—ã¾ã™ã€‚

```yml:docker-compose.yml
version: '3'
services:
  db:
    image: mysql:5.6
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: root
    volumes:
      - mysql-data:/var/lib/mysql 
    ports:
      - "4306:3306" #åˆ¥ä»¶ã§3306ã¯ä½¿ã£ã¦ã„ãŸã®ã§4306ã‚’æŒ‡å®šã—ã¾ã—ãŸ

  app:
    build: 
      context: .
      dockerfile: Dockerfile_back
    command: /bin/sh -c "rm -f /myapp/tmp/pids/server.pid && bundle exec rails s -p 3001 -b '0.0.0.0'"
    image: rails:dev
    volumes:
      - .:/myapp    #myappã¨ã„ã†ã¨ã“ã‚ã¯ä»»æ„ã§è¨­å®šã—ã¦ãã ã•ã„
      - ./app/vendor/bundle:/myapp/vendor/bundle 
    environment:
      TZ: Asia/Tokyo
      RAILS_ENV: development
    ports:
      - "3001:3001"
    depends_on: 
      - db

  front:
    build: 
      context: todo_front
      dockerfile: Dockerfile_front
    volumes:
      - ./todo_front:/todo_front
    command: /bin/sh -c "cd todo_front && yarn && yarn start"
    ports:
      - "3000:3000"

volumes:
  mysql-data:
  bundle: 
```

# Dockerfile(ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨)ã‚’ç”¨æ„ã™ã‚‹
# entrypoint.shã‚’ç”¨æ„ã™ã‚‹
Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ—¢å­˜ã®railsã‚¢ãƒ—ãƒªã®Rubyãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆã‚ã›ã¾ã—ãŸã€‚
ãã‚Œã¨myappã¨ã„ã†ã®ã¯ä»»æ„ã«ãªã‚Šã¾ã™ã€‚åˆã‚ã›ã¦ã‚‚OKã§ã™ï¼
SQLãŒ`mysql-client`ã¨å…¥åŠ›ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
ã„ã¤ã—ã‹ã€`maliadb-client`ã«çµ±ä¸€ã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚

`Dockerfile_back`ã¨`entrypoint.sh`ã¯`docker-compose.yml`ã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªéšå±¤ã«é…ç½®ã—ã¦ã„ã¾ã™ã€‚

```dockerfile:Dockerfile_back
FROM ruby:2.6.3

RUN apt-get update && \
    apt-get install -y mariadb-client nodejs vim

RUN mkdir /myapp

WORKDIR /myapp

ADD Gemfile /myapp/Gemfile
ADD Gemfile.lock /myapp/Gemfile.lock

RUN gem install bundler
RUN bundle install

ADD . /myapp

COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 3001

CMD ["rails", "server", "-b", "0.0.0.0"]
```

```sh:entrypoint.sh
#!/bin/bash
set -e

# Remove a potentially pre-existing server.pid for Rails.
rm -f /myapp/tmp/pids/server.pid

# Then exec the container's main process (what's set as CMD in the Dockerfile).
exec "$@"
```

# Dockerfileï¼ˆfrontendç”¨)
`todo_front`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸Šã«é…ç½®ã—ã¾ã™ã€‚

```Dockerfile:Dockerfile_front
FROM node:14
```

# Railså·ã®èª¿æ•´
`database.yml'ã‚’èª¿æ•´ã—ã¦ã‚ã’ã¾ã™ã€‚
socketé€šä¿¡ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€`host: db`ã«å¤‰ãˆã¦ã‚ã’ã¾ã™ã€‚

```yml:database.yml
default: &default
  adapter: mysql2
  encoding: utf8mb4
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: root
  password:
- socket: /tmp/mysql.sock
+ host: db
```

# axiosmaterial-uiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç«‹ã¡ä¸Šã’ã¾ã™ã€‚
ãã—ã¦ã€axiosã‚„material-uiã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ã¡ãªã¿ã«`exec`ã¯ã™ã§ã«ã‚³ãƒ³ãƒ†ãƒŠãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ä½¿ãˆã¾ã™ã€‚
ã‚³ãƒ³ãƒ†ãƒŠãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ãªã„æ™‚ã¯`run`ã‚’ä½¿ã„ã¾ã™ã€‚
çµ‚ã‚ã£ãŸã‚‰ã€`db`ã‚’ä½œã£ã¦ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒˆã—ã¦ã€æ¤ãˆã¦çµ‚ã‚ã‚Šã«ãªã‚Šã¾ã™ã€‚

```console:console
$ docker-compose up -d #ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹
$ docker-compose exec front npm install axios
$ docker-compose exec front npm install @material-ui/core
$ docker-compose exec app bin/rails db:create
$ docker-compose exec app bin/rails db:migrate
$ docker-compose exec app bin/rails db:seed
```

`localhost:3000`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€å‰å›ã¨åŒã˜ç”»é¢ãŒç«‹ã¡ä¸ŠãŒã‚‹ã¯ãšã§ã™ã€‚
çµ‚ã‚ã‚Š

# çµ‚ã‚ã‚Šã«
ä»Šå›ã¯ã€docker for Macã®èª¿å­ãŒæ‚ªãã€ä½•åº¦ã‚‚attachãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
å†èµ·å‹•ã™ã‚‹ã¨æ¬¡ã®ãƒ—ãƒ­ã‚»ã‚¹ã«è¡Œã‘ã¾ã—ãŸã€‚
ãªã‚“ã ã‚ã†ã€ã‚‚ã†å°‘ã—dockerã®å‹‰å¼·ã—ãŸæ–¹ãŒã„ã„ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚
